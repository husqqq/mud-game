# 压力测试说明

## ✅ 已修复的问题

### 核心问题
之前测试客户端使用简单的 `writeUTF()` 直接发送字符串，但服务器期待 `GameMessage` 对象，导致协议不匹配，服务器立即断开连接。

### 修复内容
1. **协议修复**：测试客户端现在使用正确的 `GameMessage` 协议
2. **流程简化**：测试流程简化为：连接 → 注册 → 创建角色 → 等待游戏
3. **正确响应**：客户端正确响应服务器所有提示（角色名、属性、技能）
4. **固定客户端数**：每轮固定创建 8 个客户端

## 如何运行测试

### ⚠️ 重要：需要手动操作两个终端

**终端 1：启动服务器**
```bash
run.bat
```
1. 选择游戏模式：输入 `2` (多人模式)
2. 输入玩家数量：输入 `8` (**必须是8**)
3. 等待显示："多人游戏服务器已启动，端口：12345"

**终端 2：运行压力测试**
```bash
run_stress_test.bat
```
- 按提示操作，按任意键开始测试
- 测试会自动创建 8 个客户端
- 每个客户端会自动完成注册和角色创建

## 测试流程

每个测试客户端会执行以下步骤：

```
1. 连接服务器
   ↓
2. 等待欢迎消息 (500ms)
   ↓
3. 选择注册 (发送"2")
   ↓
4. 发送用户名 (test_user_时间戳_编号)
   ↓
5. 发送密码 (test123)
   ↓
6. 服务器自动登录成功
   ↓
7. 输入角色名 (Player_编号)
   ↓
8. 属性分配 (发送空字符串，自动平均分配)
   ↓
9. 选择技能 (随机1-3)
   ↓
10. 角色创建完成
    ↓
11. 等待游戏开始 (5秒)
    ↓
12. 游戏进行中 (3秒)
    ↓
13. 断开连接
```

## 预期输出

```
========================================
第 1 轮测试：8 个客户端
========================================
[客户端 1] 开始连接...
[客户端 2] 开始连接...
...
[客户端 8] 开始连接...
[客户端 1] 开始注册和创建角色
[客户端 2] 开始注册和创建角色
...
[客户端 1] 选择注册
[客户端 1] 发送用户名: test_user_xxx_1
[客户端 1] 发送密码
[客户端 1] 输入角色名: Player_1
[客户端 1] 选择平均分配属性（发送空字符串）
[客户端 1] 选择技能: 2
[客户端 1] 角色创建完成
[客户端 1] 等待游戏开始...
...
[客户端 1] 游戏进行中...
[客户端 1] 测试完成
[客户端 1] 断开连接
...
```

## 常见问题

### Q: 为什么不能完全自动化？
A: 服务器启动需要手动输入玩家数量，这是交互式操作，无法在脚本中自动完成。

### Q: 为什么必须是8个玩家？
A: 多人游戏要等待所有玩家连接后才开始。如果服务器设置10人但测试只创建8个客户端，游戏会一直等待剩余2人。

### Q: 测试失败了怎么办？
A: 
1. 确认服务器已完全启动
2. 确认服务器设置为8个玩家
3. 查看服务器和客户端的错误日志
4. 如果出现"连接被拒绝"，检查端口12345是否被占用

### Q: 可以修改客户端数量吗？
A: 可以，修改 `src/test/MultiPlayerStressTest.java` 中的 `FIXED_CLIENTS` 常量，但服务器也必须设置相同数量。

## 简单连接测试

如果压力测试有问题，可以先运行简单连接测试：

```bash
test_simple.bat
```

这会创建一个单客户端，详细显示每一步的通信过程，便于调试。
