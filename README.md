# MUD 武侠游戏 ⚔️

一款基于 Java 的命令行武侠养成类 MUD 游戏，支持**单机冒险**与**多人联机对战**。在回合制的江湖中修炼、切磋、决斗，最终成就武林霸主！

## 🎮 游戏目标

### 单机模式
在**可自定义回合数**（默认100）内，通过修炼和战斗将战力提升至**可自定义目标**（默认1200分），成就武林霸主地位！

### 多人模式
在服务器设定的回合数内，通过训练、NPC切磋和决斗池PvP对战，成为服务器中战力最高的玩家！

## ✨ 核心特性

### 🎯 双重模式
- **单机模式**：经典的个人冒险，与各难度NPC挑战，自定义游戏时长和目标
- **联机模式**：支持创建服务器或加入房间，在决斗池中进行全服大乱斗
  - AI自动接管断线玩家，保证游戏流畅性
  - 并行战斗系统，所有玩家同时行动，提升对战节奏

### 👤 角色系统
- **六维属性**：
  - **力量 (STR)**：提升攻击力
  - **敏捷 (AGI)**：提升命中率和暴击率
  - **体质 (CON)**：提升生命值上限
  - **智力 (INT)**：提升修炼成功率
  - **运气 (LUK)**：影响暴击率和各种随机事件
  - **防御 (DEF)**：减免受到的伤害
- **三大流派**：
  - 🗡️ **刀法 (SABER)**：克制剑法
  - ⚔️ **剑法 (SWORD)**：克制拳法
  - 👊 **拳法 (FIST)**：克制刀法
  - 克制关系提供**15%伤害加成**

### ⚔️ 战斗体系
- **NPC切磋**：
  - 5种难度（简单/普通/困难/专家/大师）
  - 胜利奖励：2-4 属性点 + 5-25 战力（随难度变化）
  - 失败惩罚：损失属性点
  
- **决斗池 (PvP)**：
  - 多人在线回合制同步对决
  - 并行战斗：所有玩家同时选择目标和技能
  - 战术克制：技能相克在互相攻击时生效
  - 胜利奖励：3-7 属性点 + 15-25 战力（最高奖励）
  - 战败惩罚：损失2-4属性点
  - 逃跑惩罚：损失5-10属性点

- **修炼系统**：
  - 成功奖励：1-2 属性点（稳定提升）
  - 主流派修炼有额外加成
  - 30%几率提升生命值上限

### 🩹 回血机制
| 方式 | 回血量 | 说明 |
|------|--------|------|
| **修炼** | < 80%: 直接回80%<br>≥ 80%: 约3次回满 | 最佳回血方式 |
| **PVP胜利** | 至少回到80% | 胜者奖励 |
| **被淘汰** | 回到50% | 保底恢复 |

### ⚖️ 伤害平衡系统
- **防瞬秒**：单次伤害不超过目标35%最大血量
- **防碾压**：攻防比例超过3:1时伤害衰减
- **防拖延**：最低保证造成目标2%最大血量的伤害
- **残血机制**：当前血量影响攻击力（50%-100%）
- **多人围攻**：受到的伤害为每个攻击者min(伤害, 35%血量上限)的总和

### 🎨 人性化设计
- 角色创建支持**回车默认配置**与**随机平均分配**点数
- 初始加点输入校验，防止误操作浪费点数
- 线程安全的服务器架构
- 心跳检测与断线重连
- 属性和战力奖励**明确显示**数值

## 🚀 快速开始

### 运行环境
- **JDK 8** 或更高版本

### 启动方式 (Windows)

#### 方式一：一键启动（推荐）
1. 下载项目源代码
2. 双击运行 `run.bat`
3. 选择游戏模式：
   - 输入 `1`：单机模式（设置回合数和目标战力）
   - 输入 `2`：多人模式（输入玩家数和回合数）

#### 方式二：手动编译
```bash
# 编译
javac -encoding UTF-8 -d bin src/*.java src/io/*.java src/network/*.java src/server/*.java src/client/*.java src/test/*.java

# 单机模式
java -cp bin main.Main

# 多人服务器
java -cp bin main.server.GameServer

# 客户端连接
java -cp bin main.client.ClientMain
```

### 联机模式步骤
1. **启动服务器**：运行 `run.bat`，选择多人模式
2. **客户端连接**：其他玩家运行 `run.bat` 并输入服务器IP
3. **注册/登录**：创建账号或使用现有账号
4. **创建角色**：分配属性、选择主流派
5. **开始游戏**：所有玩家准备就绪后自动开始

## 🧪 压力测试

项目提供了多线程压力测试工具，用于检测服务器稳定性：

```bash
# 运行压力测试（需要先手动启动服务器）
run_stress_test.bat
```

详细说明请参考：
- [快速测试指南](QUICK_TEST_GUIDE.md)
- [测试说明](测试说明.md)

## 📂 项目结构

```text
MUD/
├── src/                      # 核心源代码
│   ├── Main.java            # 主入口
│   ├── Game.java            # 单机游戏逻辑
│   ├── MultiPlayerGame.java # 多人游戏逻辑
│   ├── client/              # 联机客户端
│   │   ├── ClientMain.java  # 客户端入口
│   │   └── GameClient.java  # 客户端逻辑
│   ├── server/              # 联机服务器
│   │   ├── GameServer.java  # 服务器主体
│   │   ├── ClientHandler.java # 客户端连接处理
│   │   ├── NetworkConsoleIO.java # 网络IO
│   │   └── UserAuthService.java # 用户认证
│   ├── network/             # 网络通信
│   │   ├── GameMessage.java # 消息封装
│   │   ├── MessageType.java # 消息类型
│   │   └── MessageSerializer.java # 序列化
│   ├── io/                  # IO 抽象
│   │   └── GameIO.java      # IO 接口
│   ├── test/                # 测试工具
│   │   ├── MultiPlayerStressTest.java # 压力测试
│   │   └── SimpleConnectionTest.java  # 连接测试
│   └── ...                  # 游戏核心模块
├── bin/                     # 编译输出（自动生成）
├── saves/                   # 存档目录
├── userdata/                # 用户数据
├── run.bat                  # 一键启动脚本
├── run_stress_test.bat      # 压力测试脚本
├── test_simple.bat          # 简单连接测试
├── README.md                # 项目说明（本文件）
├── QUICK_TEST_GUIDE.md      # 快速测试指南
├── 测试说明.md              # 详细测试说明
├── CHANGELOG.md             # 更新日志
└── .gitignore               # Git 忽略配置
```

## 📊 游戏机制详解

### 伤害计算公式
```
1. 减伤后攻击 = max(1, 攻击力 - 防御值×2)
2. 基础伤害 = 减伤后攻击 / 2
3. 攻防比例衰减（如果攻防比 > 3:1）
4. 随机倍率 = 0.8-1.2 (普通) 或 1.5-2.0 (暴击)
5. 克制倍率 = 1.15 (克制) 或 1.0 (不克制)
6. 计算伤害 = 基础伤害 × 随机倍率 × 克制倍率
7. 最终伤害 = min(计算伤害, 目标最大血量×35%)
8. 最终伤害 = max(最终伤害, 目标最大血量×2%)
```

### 战力计算
```
战力 = 力量×2 + 敏捷×2 + 体质 + 智力 + 运气 + 防御×2 + 主技能熟练度×10
```

### 回合制机制
- **单机模式**：每次行动（修炼/切磋/PvP）消耗1回合
- **多人模式**：所有玩家同时行动，然后进入下一回合
- **同步机制**：使用 CountDownLatch 确保回合同步

## 🛠 技术实现

### 并发处理
- `ReentrantReadWriteLock`：保护玩家列表的读写操作
- `CountDownLatch`：实现回合同步机制
- `ConcurrentHashMap`：线程安全的玩家数据存储
- `CopyOnWriteArrayList`：并发安全的玩家列表

### 网络编程
- 基于 **TCP Socket** 协议
- 自定义消息序列化/反序列化
- 心跳检测机制（可选）
- 断线重连逻辑
- AI自动接管断线玩家

### 数据持久化
- Java 序列化实现存档系统
- 支持单机和多人模式的分别存档
- 用户账号和角色数据分离存储

### 设计模式
- **工厂模式**：NPC生成 (NpcFactory)
- **策略模式**：不同IO实现 (GameIO, ConsoleIO, NetworkConsoleIO)
- **服务层模式**：战斗、训练、存档服务分离

## 📜 胜负规则

### 单机模式
- **胜利**：在设定回合数内达到目标战力
- **失败**：回合数耗尽未达目标 或 角色死亡

### 多人模式
- 游戏结束时**战力最高**的玩家获胜
- 达到最大回合数自动结束
- 显示最终战力排行榜

## 🎯 平衡性设计理念

1. **奖励层级**：PvP胜利 > NPC切磋 ≈ 修炼
2. **风险与收益**：PvP高风险高回报，修炼稳定但收益低
3. **战术深度**：技能克制、血量管理、时机选择
4. **防止极端**：伤害上下限、攻防比例衰减、残血机制
5. **回血策略**：修炼是最佳回血方式，鼓励玩家合理规划

## 🔄 更新日志

详见 [CHANGELOG.md](CHANGELOG.md)

## 📝 许可证

MIT License - 详见 [LICENSE](LICENSE)

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📧 联系方式

如有问题或建议，请通过 GitHub Issues 联系。

---

*本项目仅供学习交流使用。*

**Enjoy your martial arts journey! 🥋**
